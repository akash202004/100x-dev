# Logging, Monitoring, Alerts, and Status Pages

## 📘 Table of Contents

- [Logging](#logging)
- [Monitoring](#monitoring)
- [Alerts](#alerts)
- [Monitoring Dashboards](#monitoring-dashboards)
- [Status Pages](#status-pages)
- [Monitoring Services](#monitoring-services)
- [New Relic Setup Guide](#new-relic-setup-guide)
- [Experiment](#experiment)
- [Dashboards](#dashboards)
- [Assignment](#assignment)
- [NRQL (New Relic Query Language)](#nrql-new-relic-query-language)
- [Alerts](#nrql-new-relic-query-language)
- [APM(Application Performance Monitoring)](#nrql-new-relic-query-language)
- [Winston](#nrql-new-relic-query-language)

---

## 🪵 Logging

Logging refers to the practice of recording events, messages, or data points generated by software applications and systems. Logs can include:

- **Error Messages**: Details about errors and exceptions.
- **Access Logs**: Records of who accessed what and when.
- **Audit Logs**: Used for compliance and security tracking.

---

## 📈 Monitoring

Monitoring is the continuous observation of a system to ensure optimal operation. Key metrics include:

- **CPU Usage**
- **Memory Usage**
- **Disk I/O**
- **Disk Space**
- **Network Traffic**
- **Application Performance**

---

## 🚨 Alerts

The goal of monitoring is to **notify users when spikes or abnormalities** occur in system metrics.

Use alerts for:

- System downtime
- High CPU or memory usage
- Increased error rates

### 🛠 How to Set Up Alerts

1. **Create an Alert**
2. **Attach it to a Policy**
3. **Add Notification Channels** (Email, Slack, etc.)

![Create Alert](./Images/14.webp)
![Alert Policy](./Images/15.webp)

---

## 📊 Monitoring Dashboards

Visual dashboards help monitor system health in real-time.

![Monitoring Dashboard](./Images/1.webp)

---

## 🌐 Status Pages

Status pages communicate real-time health to end users.

- Example: [https://status.100xdevs.com](https://status.100xdevs.com)

![Status Page](./Images/2.webp)

---

## 🧰 Monitoring Services

### 🔒 Paid Services

- **AWS CloudWatch**
- **Datadog**
- **New Relic**

### 🏠 Self-Hosted

- **Prometheus + Grafana + Loki**

---

## 🛠️ New Relic Setup Guide

We’ll set up:

- Logging
- Monitoring
- Alerting

### Steps

1. **Login to New Relic**
2. **Select Stack & Machine**
   ![Stack](./Images/3.webp)
   ![Machine](./Images/4.webp)
3. **Create API Key**
   ![Key](./Images/5.webp)
4. **Run Command on Machine**
   ![Command](./Images/6.webp)

### Hosts and Observability

![Hosts](./Images/7.webp)
![Observability](./Images/8.webp)

---

## 🧪 Experiment

Simulate high CPU usage:

```js
// index.js
let c = 1;
while (true) {
  if (Math.random() < 0.1) {
    c = c + 1;
  }
}
```

### Monitor It:

- On Machine:
  ![CPU Load](./Images/9.webp)
- On New Relic:
  ![CPU in NR](./Images/10.webp)

---

## 📋 Dashboards

Create and customize dashboards:

- [New Relic Dashboards](https://one.newrelic.com/dashboards)

### Dashboard Example:

![Dashboard](./Images/11.webp)

### Add Widgets:

![Add Widget](./Images/12.webp)

---

## 🧑‍💻 Assignment

> Try to create a dashboard similar to the following:

![Assignment Dashboard](./Images/13.webp)

---

## 🧾 NRQL (New Relic Query Language)

**NRQL** is a SQL-like language used in New Relic to query app and infrastructure data.

### 🔍 CPU Usage - All Data

```sql
SELECT average(cpuPercent) AS 'CPU used %'
FROM SystemSample
WHERE (entityGuid = 'xyz')
TIMESERIES AUTO
```

![CPU Graph](./Images/16.webp)

---

### 📈 High CPU Usage Only

```sql
SELECT average(cpuPercent) AS 'CPU used %'
FROM SystemSample
WHERE (entityGuid = 'NDQ2MDY2NXxJTkZSQXxOQXwzOTczMjM4ODc0NzI4NDk0NzYz')
AND cpuPercent > 2
TIMESERIES AUTO
```

---

### 📊 Multiple Graphs in Same Timeline

```sql
SELECT average(transmitBytesPerSecond) AS 'Transmit bytes per second',
       average(receiveBytesPerSecond) AS 'Receive bytes per second'
FROM NetworkSample
WHERE (entityGuid = 'NDQ2MDY2NXxJTkZSQXxOQXwtMzE2MTI3OTkyNzM3NDEzMTE1Mw')
TIMESERIES AUTO
```

![Network Graph](./Images/17.webp)

---

### 🧩 Using Facets (Compare Multiple Hosts)

```sql
SELECT average(cpuPercent) AS 'CPU used %'
FROM SystemSample
WHERE entityGuid IN ('xyz', 'abc')
FACET entityGuid
TIMESERIES AUTO
```

![Facets Graph](./Images/18.webp)

# Alerts and Application Monitoring with New Relic

## Alerts

The goal of monitoring is to ensure that if there are spikes in some metrics, users get informed via call, messages, or Slack.

![Facets Graph](./Images/19.webp)

### Steps to Set Up Alerts

1. **Create an alert**
2. **Attach it to a policy**
3. **Add a notification to the policy** (email, Slack, etc.)

![Facets Graph](./Images/20.webp)

---

## Application Performance Monitoring (APM)

New Relic allows you to see all the logs and stats from your process, not just the host machine.

### Default Logs

By default, you will see it is tailing global nginx logs, but not the application logs:

```
/var/log/nginx/access.log
```

![Facets Graph](./Images/21.webp)

---

## Setting up APM for a Node.js Process

![Facets Graph](./Images/22.webp)

### Steps:

1. **Create a new data source with Node.js**
2. **Choose one of 5 ways to set it up** (here, we go with "on the host")
3. **Install dependencies**
   ```bash
   npm install newrelic express
   ```
4. **Update your `package.json` scripts**
   ```json
   "scripts": {
     "start": "NEW_RELIC_APP_NAME=test NEW_RELIC_LICENSE_KEY=license_key node -r newrelic index.js"
   }
   ```
5. **Create a simple Express app**

   ```js
   require("newrelic");
   const express = require("express");
   const app = express();

   app.get("/", (req, res) => {
     console.log("route hit");
     res.json({ message: "hi there" });
   });

   app.listen(3000, () => {
     console.log("listening on port 3000");
   });
   ```

6. **Load test the app**
   ```bash
   npm i -g loadtest
   loadtest -c 10 --rps 200 http://localhost:3000/
   ```

![Facets Graph](./Images/23.webp)

You will notice logs are still empty.

![Facets Graph](./Images/24.webp)

---

## Adding Application Logs

Reference: [New Relic Node.js Logs in Context](https://docs.newrelic.com/docs/logs/logs-context/configure-logs-context-nodejs/)

### Enable Log Forwarding

Update your `package.json` scripts:

```json
"scripts": {
  "start": "NEW_RELIC_APPLICATION_LOGGING_FORWARDING_ENABLED=true NEW_RELIC_APP_NAME=test NEW_RELIC_LICENSE_KEY=your_key node -r newrelic index.js"
}
```

### Add Winston as the Logger

```bash
npm install winston
```

### Update Your Code

```js
require("newrelic");
const winston = require("winston");
const logger = winston.createLogger({
  level: "info",
  format: winston.format.json(),
  defaultMeta: { service: "user-service" },
  transports: [
    new winston.transports.File({ filename: "error.log", level: "error" }),
    new winston.transports.File({ filename: "combined.log" }),
  ],
});

if (process.env.NODE_ENV !== "production") {
  logger.add(
    new winston.transports.Console({
      format: winston.format.simple(),
    })
  );
}

const express = require("express");
const app = express();

app.get("/", (req, res) => {
  logger.info("route hit");
  if (Math.random() < 0.5) {
    logger.error("there was an err");
  }
  res.json({ message: "hi there" });
});

app.listen(3000, () => {
  console.log("listening on port 3000");
});
```

![Facets Graph](./Images/25.webp)

# Winston Logger

## Transports
Winston lets you stash logs in various places (files, console, Postgres tables, etc):

```js
const logger = winston.createLogger({
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

💡 Good list of transports: [Winston Transports Documentation](https://github.com/winstonjs/winston/blob/master/docs/transports.md#postgresql-transport)

## Formats
You can combine formats for timestamps, pretty printing, and more:

```js
import winston from 'winston';
const logger = winston.createLogger({
    level: 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.prettyPrint()
    ),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' }),
    ]
});

logger.error('Hello, world!');
logger.info('Hello, world!');
```

# 📊 Metrics on Logs & Observability Guide

## 🧾 Overview

This document serves as a concise guide for adding observability and metrics on top of your logs (especially error logs), setting up performance monitoring (e.g., response times), and building a cost-effective alerting and monitoring stack.

---

## ⚠️ Error Log Metrics

To monitor spikes in error frequency or identify errors thrown too often, you can use log-based metrics. Here’s an example NRQL query to get error log trends:

```sql
SELECT count(`message`) 
FROM Log 
WHERE 
  (
    `entity.guid` = 'NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5' OR 
    `entity.guids` LIKE '%NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5%' OR 
    `service_name` = 'test' OR 
    `serviceName` = 'test' OR 
    `service.name` = 'test' OR 
    `entity.name` = 'test'
  ) 
  AND level = 'error' 
TIMESERIES AUTO
```

![Facets Graph](./Images/26.webp)

### 🎯 Track Specific Errors

To drill into specific errors:

```sql
AND message LIKE '%there was an error%'
```

![Facets Graph](./Images/27.webp)

---

## ⏱️ Performance Metrics: Mean vs Median vs Percentiles

When analyzing metrics like response time or CPU usage, **median** and **percentiles** (p95/p99) are generally better than **mean**.

### 📌 Why Not Mean?

Mean is skewed by outliers (e.g., one request taking 1000ms).

### 📌 Percentile Example

For response times:
`[1, 2, 3, 4, 4, 4, 5, 6, 7, 9, 10, 11, 11, 11, 12, 13, 13, 13, 50, 100]`

* **P95** = 50
* **P99** = 100
* **Median** = 10.5
* **Mean** = \~17.55 (skewed by 100)

### 🔍 Query Example

```sql
SELECT 
  percentile(duration, 95) * 1000 AS "P95",
  percentile(duration, 99) * 1000 AS "P99",
  median(duration * 1000) AS "Median",
  average(duration * 1000) AS "Average"
FROM Transaction
WHERE 
  entityGuid = 'NDQ2MDY2NXxBUE18QVBQTElDQVRJT058NTY0ODg2NzU5'
  AND transactionType = 'Web'
LIMIT MAX 
SINCE 1800 seconds AGO 
EXTRAPOLATE TIMESERIES
```

![Facets Graph](./Images/29.webp)

---
## Infrastructure tab

![img](./Images/28.webp)
---

## 📟 On-Call & Alerting

Services like **PagerDuty** and **BetterStack** are commonly used for on-call notifications and status alerts.

* 🔗 [BetterStack Uptime](https://betterstack.com/uptime)

> These platforms can get **very expensive** with time and scale.

---

## 💸 Cost-Effective Alternative: Open Source Monitoring Stack

Self-host these tools to save cost and retain control:

| Tool           | Purpose                    | Link                                         |
| -------------- | -------------------------- | -------------------------------------------- |
| **Grafana**    | Dashboards & Visualization | [GitHub](https://github.com/grafana/grafana) |
| **Prometheus** | Metrics Collection         | [Website](https://prometheus.io/)            |
| **Loki**       | Log Aggregation            | [GitHub](https://github.com/grafana/loki)    |

### 🛠️ Suggested Stack

* **Prometheus**: Scrape metrics
* **Loki**: Collect logs
* **Grafana**: Visualize and alert

---

## ✅ Summary

* Use **log metrics** to monitor error trends.
* Prefer **median** and **percentiles (p95/p99)** over average for performance.
* For cost savings, explore the **Grafana + Prometheus + Loki** open-source stack.

